---
title: "Making_phylo_tree"
author: "Lana Bolin"
date: "`r Sys.Date()`"
output: html_document
---

This script builds a phylogenetic tree of the species in Kamren's dataset (data.2012.pic). 

# Parking downhill

* I made a tree with 153 taxa on it, and most of the names have been changed to match my data (data.2012.pic). But there are some things to fix:
  * Line 224. I found some synonyms that should be on the pruned.tree but aren't, so I need to figure that out.
  * Line 227. I also found some genera with synonyms that are on the megaphylogeny, but not the specific species. But I should be able to include those species in the congeneric merge if I go back and add them in prior to doing the congeneric merge.
 
 <br/>
 
 Prep data
```{r, message=F}
rm(list = ls())

data.2012.pic <- read.csv("~/GitHub/SEV_Species_Interactions_Stability/data/data.2012.pic.csv")

# Load libraries
libraries <- c("tidyverse", "U.Taxonstand", "pez", "vegan", "picante", "phytools", "lattice", "Hmisc", "readxl", "ggtree", "phylotools", "readxl", "WorldFlora", "stringr", "magrittr", "car")
invisible(lapply(libraries, require, character.only = T))

# input megaphylogeny. I will prune this to include the species in my dataset.
# For TPL, accepted spacer is " " (blank space): Genus species 
# For most R phylo tools, accepted spacer is underscore: Genus_species
megaphylogeny <- read.tree("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/PhytoPhylo_manadd5.tre")

# Fix typos - remove space from all species names
data.2012.pic$taxon.new <- str_remove_all(data.2012.pic$taxon.new, " ")
megaphylogeny$tip.label <- str_remove_all(megaphylogeny$tip.label, " ")

# Opuntia macrocentra has a typo in my data, so fix that. 
# Lesquerella fendleri has a synonym that wasn't found in the TPL database, but I found it online (Physaria fendleri). So I'm just changing it in my data.
# Ecinomastus_intertextus. Echinocactus is a synonym and is in the megaphylogeny, but the species intertextus is not. Change to "Echinocactus_intertextus.
# Escobaria_vivipara. Coryphantha is a genus synonym and is in the megaphylogeny, but the species vivipara is not. Change to Coryphantha_vivipara.

data.2012.pic %<>% dplyr::mutate(taxon.new = ifelse(taxon.new == "Opuntia_macrocenta", "Opuntia_macrocentra", taxon.new),
                                 taxon.new = ifelse(taxon.new == "Lesquerella_fendleri", "Physaria_fendleri", taxon.new),
                                 taxon.new = ifelse(taxon.new == "Ecinomastus_intertextus", "Echinocactus_intertextus", taxon.new),
                                 taxon.new = ifelse(taxon.new == "Escobaria_vivipara", "Coryphantha_vivipara", taxon.new),
                                 taxon.new = ifelse(taxon.new == "Mahonia_haematocarpa", "Berberis_haematocarpa", taxon.new),
                                 taxon.new = ifelse(taxon.new == "Arabis_fendleri", "Boechera_fendleri", taxon.new),
                                 taxon.new = ifelse(taxon.new == "Cymopterus_acaulis", "Cymopterus_glomeratus", taxon.new))

# make list of all species in megaphylogeny
megaphylogeny_spp <- megaphylogeny$tip.label #extract a species list from phylogeny
#write.csv(megaphylogeny_spp, file = "tim species list.csv") # make a species list in excel so that a file of genera can be constructed by hand in excel
megaphylogeny_genera <- read.csv("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/tim_genera.csv") # import file of genera

# Remove rows where taxon.new ends with "_NA" (where the species is unidentified). ADD THESE BACK IN DURING THE CONGENERIC MERGE.
data.2012.pic.noNA <- data.2012.pic[!grepl("_NA$", data.2012.pic$taxon.new), ]

# Genera removed because of NA
setdiff(data.2012.pic$taxon.new, data.2012.pic.noNA$taxon.new)

# Make lists of my taxa that do and don't match megaphylogeny
# Note: setdiff returns items in the first set, but not in the second set.  Thus set order matters.
matched <- intersect(data.2012.pic.noNA$taxon.new, megaphylogeny$tip.label) # 76 matches
unmatched <- setdiff(data.2012.pic.noNA$taxon.new, megaphylogeny$tip.label) # 78 non-matches
```

Find synonyms in TPL database, add them to matches
```{r}
# Download TPL database, and merge the 3 parts
library(openxlsx)
dat1 <- read.xlsx("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Plants_TPL_database_part1.xlsx")
dat2 <- read.xlsx("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Plants_TPL_database_part2.xlsx")
dat3 <- read.xlsx("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Plants_TPL_database_part3.xlsx")
database <- rbind(dat1, dat2, dat3)
rm(dat1, dat2, dat3)

# run the main function of name matching
unmatched2 <- gsub('_', ' ', unmatched) #replace Genus_species with Genus species for purposes of accessing TPL
unmatchedTPL.noNA <- nameMatch(spList=unmatched2, spSource=database, max.distance=1, Append=FALSE)

# Look at species that used fuzzy matching algorithm
unmatchedTPL.noNA %>% dplyr::filter(Fuzzy == TRUE)

# "Submitted_Name" is the name in my data
# "New_name" is the synonym. It's NA if there is no synonym
# "Accepted_SPNAME" has the original name from my data if there's no synonym, and has the "New_name" if there is a synonym. So if New_Name != NA, that row has a synonym (e.g., Boechera fendleri for Arabis fendleri) that will need to be changed back to the Submitted_Name for PICs.
unmatchedTPL.noNA %>% 
  dplyr::select(Submitted_Name, New_name, Accepted_SPNAME) %>% 
  head()

# Rename some things, make some new columns
unmatchedTPL.noNA$New.Genus <- sub(" .*", "", unmatchedTPL.noNA$Accepted_SPNAME)
unmatchedTPL.noNA$Submitted_Name2 <- gsub(' ', '_', unmatchedTPL.noNA$Submitted_Name)
unmatchedTPL.noNA$Accepted_SPNAME2 <- gsub(' ', '_', unmatchedTPL.noNA$Accepted_SPNAME) # Put an underscore between genus_species
#unmatchedTPL.noNA$taxon <- unmatchedTPL.noNA$Accepted_SPNAME
#unmatchedTPL.noNA$taxon <- gsub(' ', '_', unmatchedTPL.noNA$taxon) # Put an underscore between genus_species
#unmatchedTPL.noNA$taxonold <- gsub(' ', '_', unmatchedTPL.noNA$Submitted_Name) # Make a new column with the input (old) taxon name, spacer = underscore

# Subset unmatchedTPL.noNA to species that have a new synonym
unmatchedTPL.noNA.syns <- unmatchedTPL.noNA %>% dplyr::filter(!is.na(New_name))

# These are the synonyms
unmatchedTPL.noNA.syns$New_name

# Update the list of matches - combine original matches ("matched") with species that match after looking for synonyms 
matched.syn <- union(matched, intersect(unmatchedTPL.noNA.syns$Accepted_SPNAME2, megaphylogeny$tip.label)) # 93 matches (added 17 to the original 76 matches)

# Update list of TPL names of spp STILL not on megaphylogeny. WHY ISN'T THIS 61? (78 original unmatched, plus the 17 new matches of synonyms) (There were 154 non-NA species. 93 now match the tree. So there should be 61 umatched. Why are there only 60?)
unmatched.syn <- setdiff(unmatchedTPL.noNA$Accepted_SPNAME2, megaphylogeny$tip.label) # 60
```

Some spp that are still unmatched (i.e., are in unmatched.syn) are in TPL genera not present in Zanne tree, so they will not be added in congeneric.merge (below). So, recover the original (non-TPL) generic names of these species to try to merge them as well.
```{r}
# Subset unmatchedTPL to rows of unmatched species
unmatchedTPL.unmatched.syn <- unmatchedTPL.noNA[unmatchedTPL.noNA$Accepted_SPNAME2 %in% unmatched.syn, ]  # 60 rows

# Extract TPL genus names for unmatched.syn vector
unmatched.syn.genera <- unmatchedTPL.unmatched.syn$New.Genus   # 60

# Vector of TPL genera in unmatched.syn that are NOT present in Zanne tree
unmatched.syn.noTree.genera <- setdiff(unmatched.syn.genera, megaphylogeny_genera)  # 48

# Subset unmatched TPL to rows of genera not on Zanne tree (60 rows, 48 genera)
unmatchedTPL.unmatched.syn.noTree.genera <- unmatchedTPL.noNA[unmatchedTPL.noNA$New.Genus %in% unmatched.syn.noTree.genera, ] 

# List of original (non-TPL) names of species in TPL genera NOT present in Zanne tree
unmatched.orig.names <- unmatchedTPL.unmatched.syn.noTree.genera$Submitted_Name2 %>% sort()   # 60 
unmatched.orig.genera <- unmatchedTPL.unmatched.syn.noTree.genera$Submitted_Genus %>% unique() %>% sort() # 47

# Combined list of unmatched synonyms and original spp NOT in Zanne tree. 70 species (many are redundant but a few aren't - see setdiff lines below for non-redundant taxa)
unmatched.all <- union(unmatched.syn, unmatched.orig.names) %>% sort()  # 70

setdiff(unmatched.syn, unmatched.orig.names)
setdiff(unmatched.orig.names, unmatched.syn)
```

Try to merge each of these spp into megaphylogeny by "replacing all members of the clade it belongs to with a polytomy".  
Behavior of congeneric.merge: it places the polytomy halfway between tips and the common ancestor of the genus and its sister group. Technically, it drops every member of the genus except one, places a node halfway along that remaining branch, then adds back in every member of the genus (plus the new one(s) you are merging) to that node.
```{r}
megaphylogeny_conmerge <- congeneric.merge(as.character(unmatched.all), tree = megaphylogeny, split = "_")

# Prune the tree: drop the species that are in megaphylogeny, but not in my set, where my set includes the exact matches (including synonyms) plus the ones stuck in as polytomies
# Note that the pruned tree will be a combo of my names and TPL names
pruned.tree <- drop.tip(megaphylogeny_conmerge, setdiff(megaphylogeny_conmerge$tip.label, union(matched.syn, unmatched.all)))

length(pruned.tree$tip.label) # 153

# SUMMARY OF TAXON MATCHING
cat(length(unmatched)+length(matched), "taxa in my list") 
cat(length(matched)," of my original taxa matched to megaphylogeny")
cat(length(intersect(unmatchedTPL.noNA$Accepted_SPNAME, megaphylogeny$tip.label))," additional taxa matched to megaphylogeny after standardizing to TPL name") # I think this line of code is wrong
cat(length(unmatched.syn)," additional taxa ATTEMPTED to add via polytomies")
cat(length(megaphylogeny_conmerge$tip.label)-length(megaphylogeny$tip.label), " taxa actually added via polytomies")
cat(length(pruned.tree$tip.label), " total taxa in pruned tree")
xx<-length(unmatched.syn)-(length(megaphylogeny_conmerge$tip.label)-length(megaphylogeny$tip.label))
cat("(",xx, " taxa missing b/c genus not present in megaphylogeny)")
cat("(",length(unmatched)+length(matched)-xx-length(pruned.tree$tip.label), " additional taxa missing -- doubles removed b/c synonymous??)")

# This tree has the synonym names from the database. There are 161 species on it.
plot(pruned.tree, cex = .2)
```

I need to rename the tree tips that were replaced with synonyms, so that they match Kamren's data names (data.2012.pic.noNA$taxon.new)
```{r}
# The tree has the TPL (New) names. I want it to have my original names.
pruned.tree$tip.label %>% sort()

# I want to change the names of the species that had a synonym. Here they are (24 species).
SpToChange <- unmatchedTPL.noNA.syns$Accepted_SPNAME2
SpToChange # 25

# Tree tip labels in alphabetical order
ordered.tips <- pruned.tree$tip.label %>% sort() # 157

# Original names in alphabetical order
ordered.taxa <- data.2012.pic.noNA$taxon.new %>% unique() %>% sort() # 154

# Names on the tree that aren't in my original data
setdiff(ordered.tips, ordered.taxa)

# Names in my data that aren't on the tree
setdiff(ordered.taxa, ordered.tips) 

# Replace tree labels with new names
temp.tree <- pruned.tree

data.frame(table(temp.tree$tip.label)) %>% filter(Freq > 1)

temp.tree$tip.label[19] # Chondrosum_gracile. This should change to Bouteloua_gracilis after the step below

# Make a key for replacements. "Old_name" = "New_name" (or "temp.tree$tip.label" = "data.2012.noNA$taxon.new")
replacements <- c("Amauriopsis_dissecta" = "Bahia_dissecta",
                  "Chondrosum_barbatum" = "Bouteloua_barbata",
                  "Chondrosum_eriopodum" = "Bouteloua_eriopoda",
                  "Chondrosum_gracile" = "Bouteloua_gracilis",
                  "Bouteloua_aristidoides" = "Bouteloua_gracilis",
                  "Chondrosum_hirsutum" = "Bouteloua_hirsuta",
                  "Euphorbia_albomarginata" = "Chamaesyce_albomarginata",
                  "Euphorbia_chaetocalyx" = "Chamaesyce_chaetocalyx",
                  "Euphorbia_fendleri" = "Chamaesyce_fendleri",
                  "Euphorbia_lata" = "Chamaesyce_lata",
                  "Euphorbia_revoluta" = "Chamaesyce_revoluta",
                  "Euphorbia_serpyllifolia" = "Chamaesyce_serpyllifolia",
                  "Euphorbia_serrula" = "Chamaesyce_serrula",
                  "Erioneuron_pulchellum" = "Dasyochloa_pulchella",
                  #"Echinomastus_intertextus" = "Ecinomastus_intertextus",
                  #"Escobaria_vivipara_TEMP" = "Escobaria_vivipara",
                  "Corynopuntia_clavata" = "Grusonia_clavata",
                  "Stipa_neomexicana" = "Hesperostipa_neomexicana",
                  #"Lesquerella_fendleri_TEMP" = "Lesquerella_fendleri",
                  "Physaria_pinetorum" = "Lesquerella_pinetorum",
                  "Munroa_squarrosa_TEMP" = "Munroa_squarrosa",
                  #"Opuntia_macrocentra" = "Opuntia_macrocenta",
                  "Hilaria_jamesii" = "Pleuraphis_jamesii",
                  "Salsola_kali" = "Salsola_tragus",
                  "Acleisanthes_diffusa" = "Selinocarpus_diffusus",
                  "Clerodendrum_coulteri" = "Tetraclea_coulteri",
                  #"Boechera_fendleri" = "Arabis_fendleri",
                  #"Berberis_haematocarpa" = "Mahonia_haematocarpa",
                  #"Cymopterus_glomeratus" = "Cymopterus_acaulis",
                  "Tetraneuris_argentea_TEMP" = "Tetraneuris_argentea")

temp.tree$tip.label <- ifelse(temp.tree$tip.label %in% names(replacements),
                              replacements[temp.tree$tip.label],
                              #"SUBBED",
                              temp.tree$tip.label)

data.frame(table(temp.tree$tip.label)) %>% filter(Freq > 1)

temp.tree$tip.label[19] # This should give "Bouteloua_gracilis". Yay!

# Are there any species on my new tree that aren't in my data? WHY are these on my tree if they aren't in my data?
setdiff(temp.tree$tip.label, data.2012.pic.noNA$taxon.new)

# "Berberis_haematocarpa" == Mahonia haematocarpa
# Nama genus has synonyms: Marilaunidium, Andropus, and Conanthus
# "Boechera_fendleri" == "Arabis_fendleri"

### Are there any species in my data that aren't in my tree?
setdiff(data.2012.pic.noNA$taxon.new, temp.tree$tip.label)

# Check database results for synonyms of these species
unmatchedTPL.noNA %>%
  dplyr::filter(Submitted_Name2 %in% setdiff(data.2012.pic.noNA$taxon.new, temp.tree$tip.label)) %>%
  dplyr::select(Submitted_Name2, Accepted_SPNAME2, Submitted_Genus, New.Genus)

# Check if synonym genera are on the megaphylogeny - nope. Remove them from data.
megaphylogeny_genera %>% dplyr::filter(Genus %in% c("Corynopuntia", "Monroa"))


### Anything on the tree that isn't in my data?
setdiff(temp.tree$tip.label, data.2012.pic.noNA$taxon.new)

data.2012.pic.noNA %>%
  filter(taxon.new %in% setdiff(temp.tree$tip.label, data.2012.pic.noNA$taxon.new))
```

There are some duplicate tree tips. Figure that out
```{r}
data.frame(table(temp.tree$tip.label)) %>% filter(Freq > 1)
```



#### These genera are not on the tree, so should be removed from PIC analyses.

"Grusonia" genus is also called "Corynopuntia", but neither genus is in the megaphylogeny.  
"Munroa_squarrosa". Munroa is also called Monroa, but neither genus is in the megaphylogeny.  
"Tetraneuris_argentea". Actinea is a genus synonym, but it is not in the megaphylogeny.  

```{r}
SpToRemove <- setdiff(data.2012.pic.noNA$taxon.new, temp.tree$tip.label)
SpToRemove

new.pic.data <- data.2012.pic.noNA %>% filter(!taxon.new %in% SpToRemove)
```


#### Prune tree to not include species I don't have

```{r}
temp.tree <- drop.tip(temp.tree, setdiff(temp.tree$tip.label, data.2012.pic.noNA$taxon.new))
```



Write tree files
```{r}
#write tree files
write.tree(temp.tree, file="~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Kamren.tre") 

#Newick format
write.nexus(temp.tree, file="~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Kamren.nex") #Nexus format

# Write csv of new pic data
write.csv(new.pic.data, "~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/new.pic.data.csv")


```


Code to search the tree for tips
```{r, eval=F}
temp.tree$tip.label %>% sort()
data.2012.pic.noNA$taxon.new %>% unique() %>% sort()

tips_to_find <- c("Physaria_fendleri", "Opuntia_macrocenta", "Opuntia_macrocentra", "Corynopuntia_clavata", "Monroa_squarrosa", "Echinocactus_intertextus", "Coryphantha_vivipara", "Actinea_argentea")

# Find which ones are present. None.
present_tips <- tips_to_find[tips_to_find %in% megaphylogeny$tip.label]
missing_tips <- tips_to_find[!tips_to_find %in% megaphylogeny$tip.label]

# They're all in the congeneric merge tree...
cat("Tips found:\n", present_tips, "\n")
cat("Tips missing:\n", missing_tips, "\n")
```


