---
title: "Making_phylo_tree_2004"
author: "Lana Bolin"
date: "`r Sys.Date()`"
output: html_document
---

This script builds a phylogenetic tree of the species in Kamren's dataset (data.2004.pic). 

# Parking downhill

* Line 234 -- doing congeneric merge. I need a list of all species that are unmatched to the megaphylogeny.
 
 <br/>
 
# New, clean code

 Prep data
```{r, message=F}
rm(list = ls())

data.2004.pic <- read.csv("~/GitHub/SEV_Species_Interactions_Stability/data/data.2004.pic.csv")

length(unique(data.2004.pic$kartez)) # 143 taxa

# Load libraries
libraries <- c("tidyverse", "U.Taxonstand", "pez", "vegan", "picante", "phytools", "lattice", "Hmisc", "readxl", "ggtree", "phylotools", "readxl", "WorldFlora", "stringr", "magrittr", "car")
invisible(lapply(libraries, require, character.only = T))

# input megaphylogeny. I will prune this to include the species in my dataset.
# For TPL, accepted spacer is " " (blank space): Genus species 
# For most R phylo tools, accepted spacer is underscore: Genus_species
megaphylogeny <- read.tree("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/PhytoPhylo_manadd5.tre")

# Fix typos - remove space from all species names
data.2004.pic$taxon.new <- str_remove_all(data.2004.pic$taxon.new, " ")
megaphylogeny$tip.label <- str_remove_all(megaphylogeny$tip.label, " ")

# Fix Opuntia macrocenta typo
data.2004.pic %<>% dplyr::mutate(taxon.new = ifelse(taxon.new == "Opuntia_macrocenta", "Opuntia_macrocentra", taxon.new))

# make list of all species in megaphylogeny
megaphylogeny_spp <- megaphylogeny$tip.label #extract a species list from phylogeny
megaphylogeny_genera <- read.csv("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/tim_genera.csv") # import file of genera
megaphylogeny_genera <- megaphylogeny_genera$Genus


# Remove rows where taxon.new ends with "_NA" (where the species is unidentified). None of these species have NA, but I'm leaving this here as a template for future scripts.
data.2004.pic.noNA <- data.2004.pic[!grepl("_NA$", data.2004.pic$taxon.new), ]

length(unique(data.2004.pic.noNA$kartez)) # None have NA


# Make lists of my taxa that do and don't match megaphylogeny
# Note: setdiff returns items in the first set, but not in the second set.  Thus set order matters.
matched <- intersect(data.2004.pic.noNA$taxon.new, megaphylogeny$tip.label) # 72 matches
unmatched <- setdiff(data.2004.pic.noNA$taxon.new, megaphylogeny$tip.label) # 70 non-matches
```

Find synonyms in TPL database, add them to matches
```{r}
# Download TPL database, and merge the 3 parts
library(openxlsx)
dat1 <- read.xlsx("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Plants_TPL_database_part1.xlsx")
dat2 <- read.xlsx("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Plants_TPL_database_part2.xlsx")
dat3 <- read.xlsx("~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Plants_TPL_database_part3.xlsx")
database <- rbind(dat1, dat2, dat3)
rm(dat1, dat2, dat3)

# run the main function of name matching
unmatched2 <- gsub('_', ' ', unmatched) #replace Genus_species with Genus species for purposes of accessing TPL
unmatchedTPL.noNA <- nameMatch(spList=unmatched2, spSource=database, max.distance=1, Append=FALSE)

# Filter synonym df to useful columns
unmatchedTPL.noNA %<>%
  dplyr::select(Submitted_Name, Accepted_SPNAME, Name_in_database, Submitted_Genus, Genus_in_database, Fuzzy, Score)

# Filter out rows where submitted name is same as synonym (Goes from 70 rows to 26 rows). These are the species with synonyms.
unmatchedTPL.noNA.syns <- unmatchedTPL.noNA %>%
  filter(Submitted_Name != Accepted_SPNAME)

# Look at species that used fuzzy matching algorithm - 3 rows
unmatchedTPL.noNA.syns %>% dplyr::filter(Fuzzy == TRUE)

# "Submitted_Name" is the name in my data
# "Accepted_SPNAME" has the original name from my data if there's no synonym, and has the 


# Make some new columns with underscores, and a new genus name based on "Accepted_SPNAME"
unmatchedTPL.noNA$New.Genus <- sub(" .*", "", unmatchedTPL.noNA$Accepted_SPNAME)
unmatchedTPL.noNA$Submitted_Name2 <- gsub(' ', '_', unmatchedTPL.noNA$Submitted_Name)
unmatchedTPL.noNA$Accepted_SPNAME2 <- gsub(' ', '_', unmatchedTPL.noNA$Accepted_SPNAME) # Put an underscore between genus_species

unmatchedTPL.noNA.syns$New.Genus <- sub(" .*", "", unmatchedTPL.noNA.syns$Accepted_SPNAME)
unmatchedTPL.noNA.syns$Submitted_Name2 <- gsub(' ', '_', unmatchedTPL.noNA.syns$Submitted_Name)
unmatchedTPL.noNA.syns$Accepted_SPNAME2 <- gsub(' ', '_', unmatchedTPL.noNA.syns$Accepted_SPNAME) # Put an underscore between genus_species


# These are the synonyms
syns <- unmatchedTPL.noNA.syns %>% dplyr::select(Submitted_Name2, Accepted_SPNAME2, Name_in_database)
syns

# Which of these are in the megaphylogeny? "Accepted_SPNAME2" matches what's on the megaphylogeny. Only 17 of the synonyms are on there. BUT, I think I want to use my Submmitted_Name2 nomenclature, and change those on the megaphylogeny. That way I'll maintain Bouteloua and Salsola tragus and Chamaesyce, etc., which are commonly used at SEV
syns %>%
  select(Submitted_Name2, Accepted_SPNAME2) %>%
  pivot_longer(cols = everything(),
               names_to = "column",
               values_to = "name") %>%
  filter(name %in% megaphylogeny$tip.label)

# Change megaphylogeny to match my submitted species names
replacements <- setNames(syns$Submitted_Name2, syns$Accepted_SPNAME2)

megaphylogeny$tip.label <- ifelse(
  megaphylogeny$tip.label %in% names(replacements),
  replacements[megaphylogeny$tip.label],
  megaphylogeny$tip.label
)


# Update the list of matches - combine original matches ("matched") with species that match after looking for synonyms 
matched.syn <- union(matched, intersect(unmatchedTPL.noNA.syns$Submitted_Name2, megaphylogeny$tip.label)) # 89 (we added 17 synonyms to the original 72 matches)

# Update list of TPL names of spp STILL not on megaphylogeny. 
unmatched.syn <- setdiff(unmatchedTPL.noNA$Submitted_Name2, megaphylogeny$tip.label) # 9
unmatched.syn


### Look at the ones that don't match. Which genus (old or new) is in the megaphylogeny? Change megaphylogeny to match the genus in my data.

# Names in data
sort(unique(data.2004.pic$taxon.new))

## Arabis fendleri / Boechera fendleri. Data have Arabis fendleri. Master phylogeny as Boechera and Arabis genera... So leave as Arabis, and it will get added in congeneric merge.
"Arabis_fendleri" %in% megaphylogeny$tip.label
"Boechera_fendleri" %in% megaphylogeny$tip.label
"Arabis" %in% megaphylogeny_genera
"Boechera" %in% megaphylogeny_genera

## Chenopodium graveolens / Chenopodium vulvaria. Nothing to do, will get added in congeneric merge
"Chenopodium_graveolens" %in% megaphylogeny$tip.label
"Chenopodium_vulvaria" %in% megaphylogeny$tip.label
"Chenopodium" %in% megaphylogeny_genera

## Lesquerella pinetorum / Physaria pinetorum. Physaria is in master phylogeny. Change "Physaria" to "Lesquerella" in master phylogeny.
"Lesquerella_pinetorum" %in% megaphylogeny$tip.label
"Physaria_pinetorum" %in% megaphylogeny$tip.label
"Lesquerella_fendleri" %in% megaphylogeny$tip.label
"Physaria_fendleri" %in% megaphylogeny$tip.label
"Lesquerella" %in% megaphylogeny_genera
"Physaria" %in% megaphylogeny_genera

## Nama dichotomum / Nama dichotoma; Nama hispida / Nama hispidum
# Nothing to do - will get added in congeneric merge
"Nama_hispida" %in% megaphylogeny$tip.label
"Nama_hispidum" %in% megaphylogeny$tip.label
"Nama_dichotoma" %in% megaphylogeny$tip.label
"Nama_dichotomum" %in% megaphylogeny$tip.label
"Nama" %in% megaphylogeny_genera

## Selinocarpus diffusus / Acleisanthes diffusa. Acleisanthes genus is in megaphylogeny. Change Acleisanthes to Selinocarpus in megaphylogeny.
"Selinocarpus_diffusus" %in% megaphylogeny$tip.label
"Acleisanthes_diffusa" %in% megaphylogeny$tip.label
"Selinocarpus" %in% megaphylogeny_genera
"Acleisanthes" %in% megaphylogeny_genera

## Grusonia clavata / Corynopuntia clavata. None are in master phylogeny. Manually search for other synonyms. Couldn't find any - it will get dropped from tree.
"Grusonia_clavata" %in% megaphylogeny$tip.label
"Corynopuntia_clavata" %in% megaphylogeny$tip.label
"Grusonia" %in% megaphylogeny_genera
"Corynopuntia" %in% megaphylogeny_genera


## Ecinomastus intertextus / Echinocactus intertextus. Echinocactus genus is in master phylogeny. Change Echinocactus to Ecinomastus in master phylogeny.
"Ecinomastus_intertextus" %in% megaphylogeny$tip.label
"Echinocactus_intertextus" %in% megaphylogeny$tip.label
"Ecinomastus" %in% megaphylogeny_genera
"Echinocactus" %in% megaphylogeny_genera

## Mahonia_haematocarpa / Berberis_haematocarpa. Mahonia and Berberis are both in the master phylogeny. Leave as Mahonia, will get added in congeneric merge.
"Mahonia_haematocarpa" %in% megaphylogeny$tip.label
"Berberis_haematocarpa" %in% megaphylogeny$tip.label
"Mahonia" %in% megaphylogeny_genera
"Berberis" %in% megaphylogeny_genera


"Monroa" %in% megaphylogeny_genera
"Munroa" %in% megaphylogeny_genera


## Make the above changes
# Named vector: old_genus = new_genus
genus_replacements <- c(
  "Physaria"      = "Lesquerella",
  "Acleisanthes"  = "Selinocarpus",
  "Echinocactus"  = "Ecinomastus",
  "Coryphantha" = "Escobaria"    
)

megaphylogeny$tip.label <- vapply(
  megaphylogeny$tip.label,
  function(x) {
    parts <- strsplit(x, "_")[[1]]
    if (parts[1] %in% names(genus_replacements)) {
      parts[1] <- genus_replacements[parts[1]]
    }
    paste(parts, collapse = "_")
  },
  character(1)
)

# Extract new genera from megaphylogeny
megaphylogeny_genera_new <- unique(sub("_.*", "", megaphylogeny$tip.label))
```

Look at taxon.new names in my data that are not on the megaphylogeny 
```{r}
matched.syn2 <- intersect(data.2004.pic.noNA$taxon.new, megaphylogeny$tip.label) # 90 matches
unmatched.syn2 <- setdiff(data.2004.pic.noNA$taxon.new, megaphylogeny$tip.label) # 52 non-matches

### Species in my data that are not in master phylogeny
unmatched.syn2


### Genera in my data that are not in master phylogeny
unmatched.syn2.genera <- sub("_.*", "", unmatched.syn2)

# Vector of genera in unmatched.syn2 that are NOT present in the updated Zanne tree
unmatched.syn.noTree.genera <- setdiff(unmatched.syn2.genera, megaphylogeny_genera_new)  # 2. These will be dropped
```

Do congeneric merge
```{r}
# Species still missing from the (edited) megaphylogeny (52)
unmatched_to_merge <- unmatched.syn2 %>%
  unique() %>%
  sort()

# Drop species whose genera are not in the megaphylogeny (can't be congenerically merged)
bad_genera <- c("Grusonia", "Munroa")

# 50 species going into congeneric merge (Grusonia and Munroa removed)
unmatched_to_merge <- unmatched_to_merge[
  !(sub("_.*", "", unmatched_to_merge) %in% bad_genera)
]

# Congeneric merge
megaphylogeny_conmerge <- congeneric.merge(unmatched_to_merge, tree = megaphylogeny, split = "_")
```

Prune tree
```{r}
keep <- intersect(megaphylogeny_conmerge$tip.label,
                  unique(data.2004.pic.noNA$taxon.new))

pruned_tree <- keep.tip(megaphylogeny_conmerge, keep)

length(pruned_tree$tip.label) # 140
setdiff(unique(data.2004.pic.noNA$taxon.new), pruned_tree$tip.label)   # data taxa missing from tree
setdiff(pruned_tree$tip.label, unique(data.2004.pic.noNA$taxon.new))   # should be character(0)
```



Write tree files
```{r}
#write tree files
write.tree(pruned_tree, file="~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Kamren.2004.tre") 

#Newick format
write.nexus(pruned_tree, file="~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/Kamren.2004.nex") #Nexus format

# Write csv of new pic data
#write.csv(new.pic.data, "~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/new.pic.data.2004.csv")
write.csv(data.2004.pic.noNA, "~/GitHub/SEV_Species_Interactions_Stability/data/phylo_tree/new.pic.data.2004.csv")
```








